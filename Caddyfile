:80 {
  redir https://{host}{uri} 308
}

(common) {
  tls /etc/certs/origin-cert.pem /etc/certs/origin-key.pem
  encode zstd gzip
  header {
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    X-Frame-Options "DENY"
    X-Content-Type-Options "nosniff"
    Referrer-Policy "strict-origin-when-cross-origin"
    Permissions-Policy "camera=(), microphone=(), geolocation=()"
  }

  # Statikler uzun cache
  @static path /_next/* /assets/* /static/* /favicon.ico /robots.txt
  header @static Cache-Control "public, max-age=31536000, immutable"

  # Dinamik/HTML cache'lenmesin
  @dynamic not path /_next/* /assets/* /static/* /favicon.ico /robots.txt
  header @dynamic Cache-Control "no-store"
}

fonborsa.com {
  import common
  @health path /health
  respond @health 200
  reverse_proxy landing:3000
}

trader.fonborsa.com {
  import common
  @health path /health
  respond @health 200
  reverse_proxy trader:3001
}

manager.fonborsa.com {
  import common
  @health path /health
  respond @health 200
  reverse_proxy manager:3002
}

api.fonborsa.com {
  import common

  # ⚠️ CORS burada yönetilmiyor; NestJS (main.ts) enableCors kullanıyor.
  # Preflight/OPTIONS'u da API cevaplayacak.

  reverse_proxy api:4000 {
    header_up Host {host}
    header_up X-Real-IP {remote}
    # X-Forwarded-* başlıklarını Caddy zaten ekler.
  }
}
